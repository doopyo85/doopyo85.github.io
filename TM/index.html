<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI 예측기</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
</head>
<body>
  <h2>AI 이미지 예측</h2>
  <p id="status">대기 중...</p>
  <p><b>모델:</b> <span id="modelURL">없음</span></p>
  <p><b>이미지:</b> <span id="imageURL">없음</span></p>
  <p><b>예측결과:</b> <span id="result">-</span></p>
  <canvas id="preview" width="224" height="224" style="display:none;"></canvas>

  <script>
    let model = null;
    let modelBaseURL = null;
    const statusEl = document.getElementById("status");
    const modelURLEl = document.getElementById("modelURL");
    const imageURLEl = document.getElementById("imageURL");
    const resultEl = document.getElementById("result");

    async function loadModel(baseURL) {
      statusEl.innerText = "모델 불러오는 중...";
      const modelURL = baseURL + "model.json";
      const metadataURL = baseURL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      statusEl.innerText = "모델 로드 완료!";
    }

    async function predictFromBase64(base64) {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.getElementById("preview");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, 224, 224);

        const prediction = await model.predict(canvas);
        prediction.sort((a, b) => b.probability - a.probability);
        const top = prediction[0];

        resultEl.innerText = top.className;
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(top.className);
        } else if (window.postMessage) {
          window.postMessage(top.className, "*");
        }
      };
      img.src = base64;
    }

    window.addEventListener("message", async (event) => {
      let data = event.data;
      if (typeof data !== "string") return;

      const parts = data.split("|");
      if (parts.length < 2) {
        statusEl.innerText = "전달받은 데이터 형식이 잘못되었습니다.";
        return;
      }

      let imageURL = parts[0].replace("http://", "https://");
      let newModelURL = parts[1];

      imageURLEl.innerText = imageURL;
      modelURLEl.innerText = newModelURL;

      if (!model || modelBaseURL !== newModelURL) {
        modelBaseURL = newModelURL;
        await loadModel(modelBaseURL);
      }

      statusEl.innerText = "이미지 예측 중...";
      try {
        const response = await fetch(imageURL);
        const blob = await response.blob();
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64data = reader.result;
          predictFromBase64(base64data);
        };
        reader.readAsDataURL(blob);
      } catch (err) {
        statusEl.innerText = "이미지 처리 실패: " + err.message;
      }
    });
  </script>
</body>
</html>
