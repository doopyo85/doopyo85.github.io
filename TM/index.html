<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>이미지 예측기</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>
</head>
<body>
  <canvas id="preview" width="224" height="224" style="display:none;"></canvas>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/hG6md1bwO/";
    let model, maxPredictions;

    async function loadModel() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
    }

    async function predictFromBase64(base64) {
      const img = new Image();
      img.onload = async () => {
        const canvas = document.getElementById("preview");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, 224, 224);

        const prediction = await model.predict(canvas);
        prediction.sort((a, b) => b.probability - a.probability);
        const top = prediction[0];

        // 결과를 Thunkable로 전송
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(top.className);
        } else if (window.postMessage) {
          window.postMessage(top.className, "*");
        }
      };
      img.src = base64;
    }

    // Thunkable에서 메시지 수신
    window.addEventListener("message", async (event) => {
      let fileUrl = event.data;

      if (!fileUrl.startsWith("http") && !fileUrl.startsWith("data:image")) return;

      if (!model) {
        await loadModel();
      }

      // http → https 보정
      if (fileUrl.startsWith("http://")) {
        fileUrl = fileUrl.replace("http://", "https://");
      }

      try {
        const response = await fetch(fileUrl);
        const blob = await response.blob();

        const reader = new FileReader();
        reader.onloadend = () => {
          const base64data = reader.result;
          predictFromBase64(base64data);
        };
        reader.readAsDataURL(blob);
      } catch (err) {
        const errorMessage = "이미지 변환 실패: " + err.message;
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(errorMessage);
        } else if (window.postMessage) {
          window.postMessage(errorMessage, "*");
        }
      }
    });
  </script>
</body>
</html>
