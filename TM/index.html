<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TM 이미지 예측기</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
</head>
<body>
  <canvas id="preview" width="224" height="224" style="display:none;"></canvas>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/hG6md1bwO/";
    let model;

    async function loadModel() {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
    }

    async function predictFromImage(imgUrl) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = async () => {
        const canvas = document.getElementById("preview");
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, 224, 224);

        const prediction = await model.predict(canvas);
        prediction.sort((a, b) => b.probability - a.probability);
        const top = prediction[0];

        // 결과를 Thunkable로 전송
        window.parent.postMessage(top.className, "*");
      };
      img.src = imgUrl;
    }

    // Thunkable에서 사진 경로 메시지를 받으면 처리
    window.addEventListener("message", async (event) => {
      const imgUrl = event.data;

      if (!model) {
        await loadModel();
      }

      if (typeof imgUrl === "string" && imgUrl.startsWith("data:image") || imgUrl.startsWith("http")) {
        predictFromImage(imgUrl);
      }
    });
  </script>
</body>
</html>
